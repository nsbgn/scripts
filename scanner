#!/bin/bash
# Utility to quickly scan black-and-white documents
# https://askubuntu.com/questions/106769/scanning-from-terminal
# https://manpages.ubuntu.com/manpages/bionic/en/man1/scanimage.1.html

set -euo pipefail
IFS=$'\n\t'

DPI="${DPI:-300}" # DPI resolution
FUZZ="${FUZZ:-10}" # Extent to which we tolerate colors that don't exactly match
TITLE="$(echo "${@:-document}" | tr ' ' -)" # What will be the prefix to the output file?
if ! (echo "$TITLE" | grep -q '^[0-9]\{8\}'); then
    echo "Title does not include a date, inserting current date..." >&2
    TITLE="$(date +'%Y%m%d')-$TITLE"
fi

# If there are already pictures called `${TITLE}-${NUMBER}.jpg` in the current
# directory, we will make sure that our number is one higher
NUMBER=$((1 + $( echo ${TITLE}-0.png ${TITLE}-*.png \
    | tr ' ' '\n' | sed -n "s|${TITLE}-\([0-9]\+\).png|\1|p" \
    | sort -g | tail -n 1) ))


scanimage \
        --progress \
        --resolution ${DPI} \
        -l 0 -t 0 -x 215 -y 297 \
        --format pnm \
    | convert \
        -strip \
        -colorspace gray \
        -sigmoidal-contrast 10,50% \
        -resize 1000x \
        -posterize 8 \
        -define png:compression-level=9 \
        pnm:- "PNG8:${TITLE}-${NUMBER}.png"
